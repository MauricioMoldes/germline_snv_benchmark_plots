
# Load Libraries 

library(tidyverse)
library(stringr)
library(lubridate)
library(scales)


# Static dataset 

bench_raw <- tribble(
  ~Acronym, ~version, ~n_samples, ~infra, ~walltime, ~node_hours, ~cpu_time, ~gpu_time, ~cpu_alloc,
  
  "NGC-MDx1-M","5.7",7,"queue","33h56m06s",33.94,"601h09m10s","0","per_process",
  "NGC-MDx1-S","5.7",7,"local","31h02m25s",31.04,"617h50m38s","0","50",
  "NGC-MDx2-M","5.7",7,"queue","27h45m58s",27.75,"371h57m45s","0","per_process",
  "NGC-MDx2-S","5.7",7,"local","23h58m51s",23.96,"347h10m39s","0","50",
  
  "GeG-PB1-M","4.6.0-1",7,"queue","0h26m40s",1.84,"206","14.7","112",
  "GeG-PB2-M","4.6.0-1",7,"queue","0h23m19s",1.72,"193","13.8","112",
  
  "GeG-NFCS1-M","3.7.0",7,"queue","6h30m09s",22.39,"0h37m58s","0","112",
  "GeG-NFCS2-M","3.7.0",7,"queue","7h08m29s",19.72,"0h39m22s","0","112",
  "GeG-NFCS3-M","3.7.0",7,"queue","7h25m24s",22.78,"0h47m27s","0","112",
  "GeG-NFCS4-M","3.7.0",7,"queue","6h37m34s",20.47,"0h37m43s","0","112",
  "GeG-NFCS5-M","3.7.0",7,"queue","4h35m13s",18.39,"0h36m19s","147.12","112",
  
  "GeC-NFCS1-M","3.7.0",7,"queue","5h18m44s",22.21,"0h22m28s","0","96",
  "GeC-NFCS2-M","3.7.0",7,"queue","6h07m01s",22.48,"0h24m11s","0","96",
  
  "NGC-NFCS1-M","3.7.1",7,"queue","4h53m00s",10.08,"32h16m06s","0","variable",
  "NGC-NFCS2-M","3.7.1",7,"queue","3h35m00s",7.92,"25h21m54s","0","variable",
  "NGC-SC-S","3.7.1",7,"queue","0h14m00s",1.63,"4h12m19s","0","96"
)


# Auxiliar function, time parsing 

convert_to_hours <- function(x) {
  if (str_detect(x, "h|m|s")) {
    h <- as.numeric(str_extract(x, "\\d+(?=h)"))
    m <- as.numeric(str_extract(x, "\\d+(?=m)"))
    s <- as.numeric(str_extract(x, "\\d+(?=s)"))
    
    h[is.na(h)] <- 0
    m[is.na(m)] <- 0
    s[is.na(s)] <- 0
    
    return(h + m/60 + s/3600)
  } else {
    return(as.numeric(x))
  }
}


# Clean + Create Derived Metrics

bench <- bench_raw %>%
  mutate(
    walltime_h = convert_to_hours(walltime),
    cpu_h      = convert_to_hours(cpu_time),
    gpu_h      = convert_to_hours(gpu_time),
    node_h     = as.numeric(node_hours),
    
    walltime_per_sample = walltime_h / n_samples,
    node_per_sample     = node_h / n_samples,
    
    is_gpu = gpu_h > 0
  )

# Global Theme for Paper

  theme_paper <- theme_minimal(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# FIGURE 1 :  Walltime Comparison

  ggplot(bench, aes(x = reorder(Acronym, walltime_h), 
                  y = walltime_h, 
                  fill = infra)) +
  geom_col() +
  coord_flip() +
  labs(title = "Walltime Comparison",
       x = "Pipeline",
       y = "Walltime (hours)") +
  theme_paper

# FIGURE 2 :  Total Node Hours (Compute Cost)

  ggplot(bench, aes(x = reorder(Acronym, node_h), 
                  y = node_h, 
                  fill = is_gpu)) +
  geom_col() +
  coord_flip() +
  labs(title = "Total Node Hours",
       x = "Pipeline",
       y = "Node Hours",
       fill = "GPU Used") +
  theme_paper

# FIGURE 2 : CPU vs GPU Usage

ggplot(bench, aes(x = cpu_h, 
                  y = gpu_h, 
                  size = node_h,
                  color = infra)) +
  geom_point(alpha = 0.7) +
  labs(title = "CPU vs GPU Time",
       x = "CPU Hours",
       y = "GPU Hours") +
  theme_paper


# FIGURE 4 :  Per Sample Walltime

ggplot(bench, aes(x = reorder(Acronym, walltime_per_sample), 
                  y = walltime_per_sample,
                  fill = infra)) +
  geom_col() +
  coord_flip() +
  labs(title = "Walltime per Sample",
       x = "Pipeline",
       y = "Hours per Sample") +
  theme_paper

  baseline <- max(bench$walltime_h)

bench <- bench %>%
  mutate(speedup = baseline / walltime_h)


# FIGURE 5 :  Speedup Relative to Slowest Pipeline

ggplot(bench, aes(x = reorder(Acronym, speedup), 
                  y = speedup)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Speedup Relative to Slowest Pipeline",
       x = "Pipeline",
       y = "Speedup (Ã—)") +
  theme_paper


# FIGURE 6 :  Infrastructure Effect (Queue vs Local)

  ggplot(bench, aes(x = infra, y = walltime_h, fill = infra)) +
  geom_boxplot() +
  labs(title = "Infrastructure Effect on Walltime",
       x = "Infrastructure",
       y = "Walltime (hours)") +
  theme_paper

# FIGURE 7 :  Decision Plot (Cost vs Time)

  ggplot(bench, aes(x = node_h, 
                  y = walltime_h, 
                  color = is_gpu)) +
  geom_point(size = 4) +
  labs(title = "Cost vs Turnaround Time",
       x = "Node Hours (Cost Proxy)",
       y = "Walltime (hours)",
       color = "GPU") +
  theme_paper


# outputs 


ggsave("figure_walltime.pdf", width = 8, height = 6)
ggsave("figure_node_hours.pdf", width = 8, height = 6)